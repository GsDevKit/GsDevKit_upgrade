#
iferr 1 stk
iferr 2 stack
iferr 3 exit 1
display oops
limit bytes 200
set u SystemUser p swordfish
login

run
	"Install upgrade support code"
	| codeLibrarian symbolName session symbolList symbolDict dictName symDictSlot |
	dictName := 'Upgrade_GsDevKit_SymDict'.
	symbolName := dictName asSymbol.
	session := GsCurrentSession currentSession.
	symbolList := session symbolList.
	symbolDict := symbolList
		detect: [ :each | (each at: symbolName ifAbsent: [ nil ]) == each ]
		ifNone: [ 
			| newDict |
			newDict := SymbolDictionary new
				name: symbolName;
				objectSecurityPolicy: symbolList objectSecurityPolicy;
				yourself.
			symDictSlot := System myUserProfile symbolList size.
			System myUserProfile insertDictionary: newDict at: symDictSlot + 1.
			newDict ].
	codeLibrarian := (AllUsers userWithId: 'CodeLibrarianUser') symbolList objectNamed: #CodeLibrarian.
	codeLibrarian new
		symbolDictName: dictName;
		repository: 'tonel:$ROWAN_PROJECTS_HOME/GsDevKit_upgradeDevKitImage/rowan/src/';
		load: #('GsDevKit_upgradeDevKitImage-Common' 'GsDevKit_upgradeDevKitImage-Bootstrap' 'GsDevKit_upgradeDevKitImage-Core').
	(symbolList objectNamed: 'GsuAbstractGsDevKitUpgrade') _symbolDictionary: symbolDict.
	true
%

run
	
	"Recompile of methods will be required.
		bootstrapPostLoadClassList only needed if there are classes that should not be initialized when methods 
		recompiled by bootstrap code"

	UserGlobals
		at: #GsDevKit_Image_Upgrade
		put: 
			(GsuGsDevKit_3_5_0_Upgrade 
				sourceGemStoneRelease: (GsuAbstractGemStoneRelease major: 3 minor: 2 patch: 15)).
"
				bootstrapExistingConfigurationList: #( ConfigurationOfGLASS1 );
				bootstrapPostLoadClassList: #( #SecureHashAlgorithm );
				bootstrapRepositoryDirectory: GsPackageLibrary getMonticelloRepositoryDirectory;
				yourself).
"
	System myUserProfile removeDictionaryAt: (System myUserProfile symbolList size).
	true
%

commit

errorCount

exit 

