# arg1 is the content id: GLASS, GLASS1, TODE
# arg2 is the GemStone version id: 3215, 339, 343
#
# Sequence:
#
#	createStone battery_339 3.3.9
# installGLASS1 339 
#	upgradeImage GLASS1 339
# upgradeGsDevKitImage GLASS1 339
#
set -e
contents="$1"	# GLASS, GLASS1, TODE
version="$2"	# 3215, 339, 343
shift
shift

. defStone.env

rm -f *.log *.out

newExtent -s snapshots/extent0_upgradedImage_${contents}_${version}.dbf $GEMSTONE_NAME

export upgradeLogDir=`pwd`/upgradeLogDir
export upgradeDir="$GS_HOME/shared/repos/GsDevKit_upgrade/gemstone"

pushd "${upgradeLogDir}" >& /dev/null
  # start upgradeSeasideImage
	rm -f *.log *.out
  echo "STARTING GsdevKit_upgrad upgradeImage "
	startTopaz $GEMSTONE_NAME -lq < $GS_HOME/shared/repos/GsDevKit_upgrade/bin/installGsDevKit_upgrade
	startTopaz $GEMSTONE_NAME -lq < $GS_HOME/shared/repos/GsDevKit_upgrade/bin/prepareGsDevKitImage
	startTopaz $GEMSTONE_NAME -lq < $GS_HOME/shared/repos/GsDevKit_upgrade/bin/prepareGsDevKitImage_pragma_user
	startTopaz $GEMSTONE_NAME -lq < $GS_HOME/shared/repos/GsDevKit_upgrade/bin/prepareGsDevKitImage_pragma_SystemUser
	startTopaz $GEMSTONE_NAME -lq -T 500000 < $GS_HOME/shared/repos/GsDevKit_upgrade/bin/prepareGsDevKitImage_user

	stopStone $GEMSTONE_NAME
	cp ../extents/extent0.dbf ../snapshots/extent0_preparedGsDevKitImage_${contents}_${version}.dbf
	startStone $GEMSTONE_NAME

	startTopaz $GEMSTONE_NAME -lq < $GS_HOME/shared/repos/GsDevKit_upgrade/bin/runImageTests
popd

